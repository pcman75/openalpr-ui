<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Drumul Potcoavei Cars</title>
    <!--
Fluid Gallery Template
http://www.templatemo.com/tm-500-fluid-gallery
-->
    <!-- load stylesheets -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600">
    <!-- Google web font "Open Sans" -->
    <link rel="stylesheet" href="Font-Awesome-4.7/css/font-awesome.min.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <!-- Bootstrap style -->
    <link rel="stylesheet" href="css/hero-slider-style.css">
    <!-- Hero slider style (https://codyhouse.co/gem/hero-slider/) -->
    <link rel="stylesheet" href="css/magnific-popup.css">
    <!-- Magnific popup style (http://dimsemenov.com/plugins/magnific-popup/) -->
    <link rel="stylesheet" href="css/templatemo-style.css">

    <!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/7.14.5/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.14.6/firebase.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.14.6/firebase-functions.js"></script>

    <!-- Initialize Firebase -->
    <script src="/__/firebase/init.js"></script>

    <!-- These two JS are loaded at the top for gray scale including the loader. -->

    <script src="js/jquery-1.11.3.min.js"></script>
    <!-- jQuery (https://jquery.com/download/) -->

    <!-- momentjs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.js"></script>

    <script>

        var tm_gray_site = false;

        if (tm_gray_site) {
            $('html').addClass('gray');
        }
        else {
            $('html').removeClass('gray');
        }
    </script>
</head>

<body>

    <!-- Content -->
    <div class="cd-hero">

        <!-- Navigation -->
        <div class="cd-slider-nav">
            <nav class="navbar">
                <div class="tm-navbar-bg">

                    <a class="navbar-brand text-uppercase" href="#"><i
                            class="fa fa-picture-o tm-brand-icon"></i>Cars</a>

                    <button class="navbar-toggler hidden-lg-up" type="button" data-toggle="collapse"
                        data-target="#tmNavbar">
                        &#9776;
                    </button>
                    <div class="collapse navbar-toggleable-md text-xs-center text-uppercase tm-navbar" id="tmNavbar">
                        <ul class="nav navbar-nav">
                            <li class="nav-item active selected">
                                <a class="nav-link" href="#0" data-no="1">Today<span
                                        class="sr-only">(current)</span></a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#0" data-no="2">Yesterday</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#0" data-no="3">Search</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#0" data-no="5">Logout</a>
                            </li>
                        </ul>
                    </div>
                </div>

            </nav>
        </div>

        <ul class="cd-hero-slider">

            <!-- Page 1 Gallery One -->
            <li class="selected">
                <div class="cd-full-width">
                    <div class="container-fluid js-tm-page-content" data-page-no="1" data-page-type="gallery">
                        <div class="tm-img-gallery-container">
                            <div class="tm-img-gallery gallery-one" id="cars-today" />
                        </div>
                    </div>
                </div>
            </li>

            <!-- Page 2 Gallery Two -->
            <li>
                <div class="cd-full-width">
                    <div class="container-fluid js-tm-page-content" data-page-no="2" data-page-type="gallery">
                        <div class="tm-img-gallery-container">
                            <div class="tm-img-gallery gallery-two" id="cars-yesterday" />
                        </div>
                    </div>
                </div>
            </li>

            <!-- Page 3 Gallery Three -->
            <li>
                <div class="cd-full-width">
                    <div class="container-fluid js-tm-page-content" data-page-no="3" data-page-type="gallery">
                        <div class="tm-img-gallery-container">
                            <div class="tm-img-gallery gallery-three" id="cars-search" />
                        </div> <!-- .tm-img-gallery-container -->
                    </div>
                </div>
            </li>
        </ul> <!-- .cd-hero-slider -->

        <footer class="tm-footer">
            <p class="tm-copyright-text">Copyright &copy; <span class="tm-copyright-year">current year</span> Casa Leia
            </p>
        </footer>

    </div> <!-- .cd-hero -->


    <!-- Preloader, https://ihatetomatoes.net/create-custom-preloading-screen/ -->
    <div id="loader-wrapper">

        <div id="loader"></div>
        <div class="loader-section section-left"></div>
        <div class="loader-section section-right"></div>

    </div>

    <!-- load JS files -->

    <script src="js/tether.min.js"></script> <!-- Tether (http://tether.io/)  -->
    <script src="js/bootstrap.min.js"></script> <!-- Bootstrap js (v4-alpha.getbootstrap.com/) -->
    <script src="js/hero-slider-main.js"></script> <!-- Hero slider (https://codyhouse.co/gem/hero-slider/) -->
    <script src="js/jquery.magnific-popup.min.js"></script>
    <!-- Magnific popup (http://dimsemenov.com/plugins/magnific-popup/) -->

    <script>

        function adjustHeightOfPage(pageNo) {

            console.log(`Start adjusting page ${pageNo} height`);

            var pageContentHeight = 0;

            var pageType = $('div[data-page-no="' + pageNo + '"]').data("page-type");

            if (pageType != undefined && pageType == "gallery") {
                pageContentHeight = $(".cd-hero-slider li:nth-of-type(" + pageNo + ") .tm-img-gallery-container").height();
            }
            else {
                pageContentHeight = $(".cd-hero-slider li:nth-of-type(" + pageNo + ") .js-tm-page-content").height() + 20;
            }

            // Get the page height
            var totalPageHeight = $('.cd-slider-nav').height()
                + pageContentHeight
                + $('.tm-footer').outerHeight();

            // Adjust layout based on page height and window height
            if (totalPageHeight > $(window).height()) {
                $('.cd-hero-slider').addClass('small-screen');
                $('.cd-hero-slider li:nth-of-type(' + pageNo + ')').css("min-height", totalPageHeight + "px");
            }
            else {
                $('.cd-hero-slider').removeClass('small-screen');
                $('.cd-hero-slider li:nth-of-type(' + pageNo + ')').css("min-height", "100%");
            }
            console.log(`End adjusting page ${pageNo} height`);
        }

        if (location.hostname === "localhost" || location.hostname === "127.0.0.1") {
            console.log("It's a local server!");
            firebase.functions().useFunctionsEmulator('http://localhost:5001')
        }
        // Initialize Cloud Functions through Firebase
        let functions = firebase.functions();

        let getplates = firebase.functions().httpsCallable('getplates');

        /*
            Everything is loaded including images.
        */
        $(window).load(function () {

            console.log("Everything is loaded including images.");
            async function getCarsGalery(startDateTime, endDateTime) {

                let find = {};
                if (startDateTime) {
                    if (find.epoch_start)
                        find.epoch_start.$gt = startDateTime.getTime();
                    else
                        find.epoch_start = { $gt: startDateTime.getTime() };
                }
                if (endDateTime) {
                    if (find.epoch_start)
                        find.epoch_start.$lt = endDateTime.getTime();
                    else
                        find.epoch_start = { $lt: endDateTime.getTime() };
                }
                //find = { epoch_start: { $gt: startDateTime.getTime(), $lt: endDateTime.getTime() } }
                return getplates({ find: find }).then((result) => {
                    let table = result.data;
                    displaydata = table.data.map(row => {

                        let rowData = row.map((val, idx) => {
                            if (table.header[idx] === "epoch_start") {
                                return new moment(val, 'x').format('MMM DD LTS');
                            }
                            else
                                return val;
                        })
                        return `<div class="grid-item">
                            <figure class="effect-sadie">
                                <img src="data:image/jpeg;base64,${rowData[table.header.indexOf("vehicle_crop_jpeg")]}" alt="Image" class="img-fluid tm-img">
                                <figcaption>
                                    <h2 class="tm-figure-title">${rowData[table.header.indexOf("epoch_start")]}</h2>
                                    <p class="tm-figure-description">${rowData[table.header.indexOf("best_plate_number")]}</p>
                                    <a href="https://storage.cloud.google.com/openalpr-files/${rowData[table.header.indexOf('best_uuid')]}.mp4">View more</a>
                                </figcaption>           
                            </figure>
                        </div>`;
                    });
                    return displaydata;
                });
            }



            let today = new Date();
            today.setHours(0, 0, 0, 0); //begining of the day

            let yesterday = new Date(today.getTime());
            yesterday.setDate(yesterday.getDate() - 1); //yesterday

            //today
            getCarsGalery(today).then((data) => {
                $("#cars-today").append(data);
                console.log("added today cars");
                // wait 1 second
                setTimeout(function () {
                    adjustHeightOfPage(1);
                }, 1000);
                adjustHeightOfPage(1); // Adjust page height
                // /* Gallery One pop up
                // -----------------------------------------*/
                // $('.gallery-one').magnificPopup({
                //     delegate: 'a', // child items selector, by clicking on it popup will open
                //     type: 'image',
                //     gallery: { enabled: true }
                // });
            });

            //yesterday
            getCarsGalery(yesterday, today).then((data) => {
                $("#cars-yesterday").html(data);
                console.log("added yesterday cars");

            //     /* Gallery Two pop up
            // -----------------------------------------*/
            //     $('.gallery-two').magnificPopup({
            //         delegate: 'a',
            //         type: 'image',
            //         gallery: { enabled: true }
            //     });

            });




            console.log("magnificPopup");



            /* Gallery Three pop up
            -----------------------------------------*/
            $('.gallery-three').magnificPopup({
                delegate: 'a',
                type: 'image',
                gallery: { enabled: true }
            });

            /* Collapse menu after click 
            -----------------------------------------*/
            $('#tmNavbar a').click(function () {
                $('#tmNavbar').collapse('hide');

                adjustHeightOfPage($(this).data("no")); // Adjust page height       
            });

            /* Browser resized 
            -----------------------------------------*/
            $(window).resize(function () {
                var currentPageNo = $(".cd-hero-slider li.selected .js-tm-page-content").data("page-no");

                // wait 3 seconds
                setTimeout(function () {
                    adjustHeightOfPage(currentPageNo);
                }, 1000);

            });

            // Remove preloader (https://ihatetomatoes.net/create-custom-preloading-screen/)
            $('body').addClass('loaded');

            // Write current year in copyright text.
            $(".tm-copyright-year").text(new Date().getFullYear());

        });

        // DOM is ready
        $(function () {
            console.log("DOM is ready")
        });

    </script>

</body>

</html>